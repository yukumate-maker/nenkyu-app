<script>
const DAY_MIN = 465;
const $ = id => document.getElementById(id);

let user = JSON.parse(localStorage.getItem("user"));
let works = JSON.parse(localStorage.getItem("works") || "[]");
let breaks = JSON.parse(localStorage.getItem("breaks") || "[]");

if(user) start();

function saveSetup(){
  if(!$("name").value){
    alert("名前を入力してください");
    return;
  }
  const d = Number($("initDay").value || 0);
  const h = Number($("initHour").value || 0);
  const m = Number($("initMin").value || 0);

  if(d===0 && h===0 && m===0){
    alert("年休日数を入力してください");
    return;
  }

  user = {
    name: $("name").value,
    total: d*DAY_MIN + h*60 + m,
    history: []
  };
  localStorage.setItem("user", JSON.stringify(user));
  start();
}

function start(){
  $("setup").style.display="none";
  $("main").style.display="block";
  $("title").textContent = `${user.name}さんの年休`;
  loadSelects();
  render();
}

function loadSelects(){
  $("workSelect").innerHTML = works.length
    ? works.map((w,i)=>`<option value="${i}">${w.name} ${w.start}〜${w.end}</option>`).join("")
    : `<option value="">就業時間を設定してください</option>`;

  $("breakSelect").innerHTML =
    `<option value="">休憩なし</option>` +
    breaks.map((b,i)=>`<option value="${i}">${b.name} ${b.start}〜${b.end}</option>`).join("");
}

function toMin(t){
  const [h,m]=t.split(":").map(Number);
  return h*60+m;
}

function overlap(a,b,c,d){
  return Math.max(0,Math.min(b,d)-Math.max(a,c));
}

function useLeave(){
  if(!$("date").value||!$("start").value||!$("end").value){
    alert("未入力です");
    return;
  }
  if($("workSelect").value===""){
    alert("就業時間を選択してください");
    return;
  }

  const s=toMin($("start").value);
  const e=toMin($("end").value);
  if(e<=s){
    alert("時間が不正です");
    return;
  }

  const w=works[$("workSelect").value];
  let used;

  if(s===toMin(w.start)&&e===toMin(w.end)){
    used=DAY_MIN;
  }else{
    used=e-s;
    if($("breakSelect").value!==""){
      const b=breaks[$("breakSelect").value];
      used-=overlap(s,e,toMin(b.start),toMin(b.end));
    }
    used=Math.ceil(used/60)*60;
  }

  user.total-=used;
  user.history.unshift({
    date:$("date").value,
    time:`${$("start").value}〜${$("end").value}`,
    used
  });
  localStorage.setItem("user",JSON.stringify(user));
  render();
}

function render(){
  const d=Math.floor(user.total/DAY_MIN);
  const r=user.total%DAY_MIN;

  $("remain").textContent =
    `${d}日${Math.floor(r/60)}時間${r%60}分`;

  $("history").innerHTML="";
  user.history.forEach((h,i)=>{
    const div=document.createElement("div");
    div.className="history";
    div.innerHTML=`
      <span>
        ${h.date}
        <div class="small">${h.time || ""}</div>
      </span>
      <span>${h.used===DAY_MIN?"1日":Math.floor(h.used/60)+"時間"}</span>
    `;
    div.onclick=()=>{
      user.total+=h.used;
      user.history.splice(i,1);
      localStorage.setItem("user",JSON.stringify(user));
      render();
    };
    $("history").appendChild(div);
  });
}

/* 設定 */
function openModal(){ $("modal").style.display="flex"; showMenu(); }
function closeModal(){ $("modal").style.display="none"; loadSelects(); }
function showMenu(){ $("menu").style.display="block"; $("workSet").style.display=$("breakSet").style.display="none"; }
function showWork(){ $("menu").style.display="none"; $("workSet").style.display="block"; renderWorks(); }
function showBreak(){ $("menu").style.display="none"; $("breakSet").style.display="block"; renderBreaks(); }

function addWork(){
  works.push({name:$("wName").value,start:$("wStart").value,end:$("wEnd").value});
  localStorage.setItem("works",JSON.stringify(works));
  renderWorks();
}
function renderWorks(){
  $("workList").innerHTML="";
  works.forEach((w,i)=>{
    $("workList").innerHTML+=`
      <div>${w.name} ${w.start}-${w.end}
      <span onclick="works.splice(${i},1);localStorage.setItem('works',JSON.stringify(works));renderWorks()">削除</span></div>`;
  });
}

function addBreak(){
  breaks.push({name:$("bName").value,start:$("bStart").value,end:$("bEnd").value});
  localStorage.setItem("breaks",JSON.stringify(breaks));
  renderBreaks();
}
function renderBreaks(){
  $("breakList").innerHTML="";
  breaks.forEach((b,i)=>{
    $("breakList").innerHTML+=`
      <div>${b.name} ${b.start}-${b.end}
      <span onclick="breaks.splice(${i},1);localStorage.setItem('breaks',JSON.stringify(breaks));renderBreaks()">削除</span></div>`;
  });
}

function resetUser(){
  if(confirm("初期設定をやり直しますか？\n※就業時間・休憩時間は保持されます")){
    localStorage.removeItem("user"); // ← userだけ削除
    location.reload();
  }
}
</script>
</body>
</html>
